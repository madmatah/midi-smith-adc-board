name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  lint_and_format_check:
    name: Lint + format-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cmake ninja-build clang-format python3-pip

      - name: Install cpplint
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install cpplint

      - name: Cache CMake FetchContent (_deps)
        uses: actions/cache@v4
        with:
          path: build/Host-Debug/_deps
          key: ${{ runner.os }}-cmake-deps-host-${{ hashFiles('CMakePresets.json', '**/CMakeLists.txt', 'cmake/**/*.cmake') }}
          restore-keys: |
            ${{ runner.os }}-cmake-deps-host-

      - name: Configure (Host-Debug)
        run: cmake --preset Host-Debug

      - name: Lint (cpplint)
        run: cmake --build --preset Host-Debug --target lint

      - name: Format check (clang-format)
        run: |
          files="$(
            git ls-files \
              'app/**/*.c' 'app/**/*.cpp' 'app/**/*.h' 'app/**/*.hpp' \
              'bsp/**/*.c' 'bsp/**/*.cpp' 'bsp/**/*.h' 'bsp/**/*.hpp' \
              'domain/**/*.c' 'domain/**/*.cpp' 'domain/**/*.h' 'domain/**/*.hpp' \
              'os/**/*.c' 'os/**/*.cpp' 'os/**/*.h' 'os/**/*.hpp' \
              'tests/**/*.c' 'tests/**/*.cpp' 'tests/**/*.h' 'tests/**/*.hpp'
          )"

          if [ -n "$files" ]; then
            echo "$files" | xargs clang-format --dry-run --Werror
          fi

  host_tests:
    name: Host tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cmake ninja-build git

      - name: Cache CMake FetchContent (_deps)
        uses: actions/cache@v4
        with:
          path: build/Host-Debug/_deps
          key: ${{ runner.os }}-cmake-deps-host-${{ hashFiles('CMakePresets.json', '**/CMakeLists.txt', 'cmake/**/*.cmake') }}
          restore-keys: |
            ${{ runner.os }}-cmake-deps-host-

      - name: Configure (Host-Debug)
        run: cmake --preset Host-Debug

      - name: Build unit tests
        run: cmake --build --preset Host-Debug --target unit_tests

      - name: Run tests
        run: ctest --test-dir build/Host-Debug --output-on-failure

  firmware_release_build:
    name: Build firmware
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools + ARM GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cmake ninja-build \
            gcc-arm-none-eabi binutils-arm-none-eabi \
            libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib

      - name: Configure (Release)
        run: cmake --preset Release

      - name: Build (Release)
        run: cmake --build --preset Release

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-release
          if-no-files-found: error
          path: |
            build/Release/adc-board.elf
            build/Release/adc-board.map

  firmware_size_analysis:
    name: Firmware size analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Install tools + ARM GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cmake ninja-build \
            gcc-arm-none-eabi binutils-arm-none-eabi \
            libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib

      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Build PR
        working-directory: pr
        run: |
          cmake --preset Release -DFORCE_DEBUG_SYMBOLS=ON
          cmake --build --preset Release | tee build_output.txt
          cp build/Release/adc-board.elf ../pr.elf

          echo "## ðŸ“Š Memory Usage (PR Branch)" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          # Extract from 'Memory region' to the line with 'FLASH'
          sed -n '/Memory region/,/FLASH/p' build_output.txt >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Bloaty Size Analysis" >> $GITHUB_STEP_SUMMARY

      - name: Checkout Base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Build Base
        working-directory: base
        run: |
          cmake --preset Release -DFORCE_DEBUG_SYMBOLS=ON
          cmake --build --preset Release
          cp build/Release/adc-board.elf ../base.elf

      - name: Run Bloaty
        uses: carlosperate/bloaty-action@v1
        with:
          bloaty-args: pr.elf -- base.elf
          output-to-summary: true
          summary-title: "Memory Impact Report (vs ${{ github.base_ref }})"
